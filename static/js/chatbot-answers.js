// js/chatbot-answers.js
// Расширенная база типовых вопросов и ответов для чат-бота

export const chatbotAnswers = [
  {
    keywords: ["доставка", "сколько", "стоимость", "цена", "условия"],
    answer: "Доставка по Казахстану бесплатная при заказе от 50 000 ₸. В другие страны — по тарифам транспортных компаний."
  },
  {
    keywords: ["гарантия", "сервис", "ремонт"],
    answer: "На всю технику предоставляется официальная гарантия производителя. Сервисные центры указаны на странице 'Сервисные центры'."
  },
  {
    keywords: ["оплата", "картой", "наличными", "рассрочка"],
    answer: "Вы можете оплатить заказ наличными, картой или оформить рассрочку прямо на сайте."
  },
  {
    keywords: ["возврат", "обмен", "вернуть", "заменить"],
    answer: "Вы можете вернуть или обменять товар в течение 14 дней при сохранении товарного вида и чека."
  },
  {
    keywords: ["контакты", "телефон", "email", "связаться"],
    answer: "Наш телефон: +7 (777) 123-45-67, email: info@technolife.kz. Также вы можете воспользоваться формой обратной связи на сайте."
  },
  {
    keywords: ["работа", "вакансия", "карьера"],
    answer: "Актуальные вакансии размещены на странице 'О компании'. Присылайте резюме на info@technolife.kz."
  },
  {
    keywords: ["адрес", "магазин", "где", "находится"],
    answer: "Наши магазины: г. Алматы, ул. Абая, 150 и г. Астана, пр. Республики, 45."
  },
  {
    keywords: ["подарочная карта", "сертификат", "подарок"],
    answer: "Подарочные карты можно приобрести на странице 'Подарочные карты'. Доступны номиналы от 5 000 до 100 000 ₸."
  },
  {
    keywords: ["акция", "скидка", "распродажа", "спецпредложение"],
    answer: "Все актуальные акции и скидки вы найдёте на странице 'Акции'. Следите за обновлениями!"
  },
  {
    keywords: ["отслеживать", "статус заказа", "где заказ", "отследить"],
    answer: "Статус заказа можно посмотреть в личном кабинете в разделе 'История заказов'."
  },
  {
    keywords: ["бонусы", "баллы", "программа лояльности", "накопить"],
    answer: "За каждую покупку вы получаете бонусные баллы. Их можно использовать для оплаты следующих заказов. Подробнее — в разделе 'Бонусы'."
  },
  {
    keywords: ["отзыв", "оценка", "написать отзыв", "рейтинг"],
    answer: "Вы можете оставить отзыв о товаре на его странице. Ваше мнение важно для нас!"
  },
  {
    keywords: ["работа сайта", "не работает", "ошибка", "проблема"],
    answer: "Если вы столкнулись с ошибкой на сайте, пожалуйста, опишите проблему или позвоните по телефону поддержки. Мы всё исправим!"
  },
  {
    keywords: ["время работы", "режим работы", "график"],
    answer: "Наш интернет-магазин работает круглосуточно. Магазины в городах открыты с 9:00 до 21:00 без выходных."
  },
  {
    keywords: ["спасибо", "благодарю", "классно", "супер"],
    answer: "Спасибо за ваш отзыв! Мы стараемся для вас."
  },
  {
    keywords: ["как оформить заказ", "оформление заказа", "пошаговая инструкция заказа", "как купить"],
    answer: "Чтобы оформить заказ: 1) Выберите товар и добавьте его в корзину. 2) Перейдите в корзину и нажмите 'Оформить заказ'. 3) Заполните данные для доставки и выберите способ оплаты. 4) Подтвердите заказ. После оформления вы получите уведомление на email."
  },
  {
    keywords: ["можно ли изменить заказ", "изменить заказ", "добавить товар в заказ", "убрать товар из заказа"],
    answer: "После оформления заказа вы можете изменить его, связавшись с нашей службой поддержки по телефону или через чат. Если заказ ещё не передан в доставку, мы внесём изменения."
  },
  {
    keywords: ["как использовать промокод", "промокод", "скидочный код", "где ввести промокод"],
    answer: "Промокод можно ввести на этапе оформления заказа в специальном поле. После ввода сумма заказа будет пересчитана с учётом скидки."
  },
  {
    keywords: ["что делать если товар не подошёл", "не подошёл товар", "вернуть товар после покупки", "не понравился товар"],
    answer: "Если товар не подошёл, вы можете вернуть его в течение 14 дней при сохранении товарного вида и упаковки. Подробнее — в разделе 'Возврат и обмен'."
  },
  {
    keywords: ["как получить чек", "электронный чек", "чек на почту", "где чек"],
    answer: "Электронный чек будет отправлен на ваш email после оплаты заказа. Также вы можете скачать чек в личном кабинете в разделе 'История заказов'."
  },
  {
    keywords: ["можно ли оплатить при получении", "оплата при получении", "наложенный платёж", "оплата курьеру"],
    answer: "Да, вы можете выбрать оплату при получении наличными или картой, если доставка осуществляется по Казахстану."
  },
  {
    keywords: ["как узнать о новых поступлениях", "новинки", "поступления", "новые товары"],
    answer: "О новых поступлениях вы можете узнать на странице 'Новинки', а также подписавшись на нашу рассылку или в соцсетях."
  },
  {
    keywords: ["как работает бонусная программа", "бонусная программа", "как получить баллы", "как потратить баллы"],
    answer: "Бонусные баллы начисляются за каждую покупку. 1 балл = 1 ₸. Баллы можно использовать для оплаты до 50% стоимости следующего заказа. Подробнее — в разделе 'Бонусы'."
  },
  {
    keywords: ["можно ли оформить рассрочку онлайн", "рассрочка онлайн", "как оформить рассрочку", "условия рассрочки"],
    answer: "Рассрочку можно оформить онлайн прямо на сайте. Выберите нужный товар, добавьте в корзину и выберите способ оплаты 'Рассрочка'. Условия зависят от банка-партнёра."
  },
  {
    keywords: ["как оставить отзыв", "написать отзыв", "где оставить отзыв", "отзыв о магазине"],
    answer: "Оставить отзыв можно на странице товара или в разделе 'Отзывы'. Ваше мнение важно для нас!"
  },
  {
    keywords: ["что делать если не пришёл заказ", "заказ не пришёл", "долго нет заказа", "где мой заказ"],
    answer: "Если заказ не пришёл в указанные сроки, пожалуйста, свяжитесь с нашей службой поддержки. Мы проверим статус доставки и поможем решить вопрос."
  },
  {
    keywords: ["можно ли купить в кредит", "покупка в кредит", "кредит онлайн", "условия кредита"],
    answer: "Покупку в кредит можно оформить онлайн. Подробнее об условиях — на странице 'Рассрочка и кредит'."
  },
  {
    keywords: ["как получить консультацию", "консультация специалиста", "помощь с выбором", "подобрать товар"],
    answer: "Наши специалисты помогут подобрать технику под ваши задачи. Оставьте заявку в чате или позвоните по телефону — мы свяжемся с вами!"
  },
  {
    keywords: ["есть ли самовывоз", "самовывоз", "где забрать заказ", "пункт выдачи"],
    answer: "Вы можете выбрать самовывоз из наших магазинов в Алматы и Астане. Адреса и график работы — на странице 'Контакты'."
  },
  {
    keywords: ["можно ли изменить адрес доставки", "изменить адрес", "другой адрес доставки", "адрес доставки"],
    answer: "Изменить адрес доставки можно до передачи заказа в доставку. Обратитесь в службу поддержки или измените адрес в личном кабинете."
  },
  {
    keywords: ["как получить гарантийный ремонт", "гарантийный ремонт", "ремонт по гарантии", "где сервис"],
    answer: "Для гарантийного ремонта обратитесь в авторизованный сервисный центр с чеком и гарантийным талоном. Адреса сервисов — на странице 'Сервисные центры'."
  },
  {
    keywords: ["можно ли заказать товар в другой город", "доставка в другой город", "отправка в регион", "заказать в другой город"],
    answer: "Мы доставляем заказы по всему Казахстану и в другие страны. Укажите нужный город при оформлении заказа."
  },
  {
    keywords: ["как отменить заказ", "отмена заказа", "отменить заказ", "отказаться от заказа"],
    answer: "Вы можете отменить заказ до передачи его в доставку. Для этого обратитесь в службу поддержки или отмените заказ в личном кабинете."
  },
  {
    keywords: ["можно ли получить консультацию по телефону", "консультация по телефону", "позвонить консультанту", "телефон консультанта"],
    answer: "Позвоните по номеру +7 (777) 123-45-67 — наши консультанты ответят на все ваши вопросы."
  },
  {
    keywords: ["есть ли доставка за пределы Казахстана", "международная доставка", "доставка в другую страну", "отправка за границу"],
    answer: "Да, мы осуществляем международную доставку. Условия и стоимость уточняйте у менеджера."
  },
  // ...добавьте свои вопросы и ответы
];

// Функция Левенштейна для нечёткого поиска (простая реализация)
function levenshtein(a, b) {
  const an = a.length, bn = b.length;
  if (an === 0) return bn;
  if (bn === 0) return an;
  const matrix = [];
  for (let i = 0; i <= bn; ++i) matrix[i] = [i];
  for (let j = 0; j <= an; ++j) matrix[0][j] = j;
  for (let i = 1; i <= bn; ++i) {
    for (let j = 1; j <= an; ++j) {
      matrix[i][j] = Math.min(
        matrix[i - 1][j] + 1,
        matrix[i][j - 1] + 1,
        matrix[i - 1][j - 1] + (b.charAt(i - 1) === a.charAt(j - 1) ? 0 : 1)
      );
    }
  }
  return matrix[bn][an];
}

// Приветствие (можно расширить)
const greetings = [
  "привет", "здравствуйте", "добрый день", "добрый вечер", "доброе утро", "hello", "hi"
];

let greeted = false;

export function getChatbotAnswer(userText) {
  const text = userText.toLowerCase();
  // Приветствие
  if (!greeted && greetings.some(g => text.includes(g))) {
    greeted = true;
    return "Здравствуйте! Я виртуальный помощник TechnoLife. Чем могу помочь?";
  }
  // Поиск точного совпадения
  for (const item of chatbotAnswers) {
    if (item.keywords.some(word => text.includes(word))) {
      return item.answer;
    }
  }
  // Поиск по опечаткам (расстояние Левенштейна <=2)
  for (const item of chatbotAnswers) {
    for (const word of item.keywords) {
      const wordsInText = text.split(/\s|[.,!?;:]/).filter(Boolean);
      for (const w of wordsInText) {
        if (levenshtein(w, word) <= 2) {
          return item.answer + " (Понял ваш вопрос несмотря на опечатку)";
        }
      }
    }
  }
  return "Спасибо за ваш вопрос! Ожидайте ответа оператора или уточните, пожалуйста, ваш запрос.";
}
